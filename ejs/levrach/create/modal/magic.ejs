<div id="when_quest_finished"></div>

<%
var prescript_id;


function CopyNameFromType( type, name )
{
  name
    .keyup(function()
    {
      $(this).prop('user_change', $(this).val().length > 0);
      console.log('keyup');
    });

  type
    .change(function()
    {
      var key = $(this).val();
      var val = 
        $(this)
          .siblings()
          .find('[role="option"] [data-option="' + key + '"]')
          .html();

      if (!name.prop('user_change'))
        name.val(val);
    });
}


function DeferCascade()
{
  var context = this;
  var first = $(this.first());
  var name = first.find("input");  
  var type = first.nextAll("[data-mark='type']").find("input").attr('name', 'type');
  first.nextAll("[data-mark='hivrach']").find('input').attr('name', 'hivrach');
  first.nextAll('[data-mark="snap"]').find('.bfh-datepicker').bfhdatepicker();

  CopyNameFromType(type, name);

  function CreateOperation()
  {
    var hivrach = first.nextAll("[data-mark='hivrach']").find('input').val();

    function RedirectToPrint()
    {
      phoxy.ApiRequest('user/Name', [hivrach], function(d)
      {
        $('#when_quest_finished').click(function()
        {
          phoxy.Defer(function()
          {
            window.bootstrap();
            window.bootstrap();
            '/web/operblock/print_page.php?ejs=print/agree&id=' + prescript_id
          }, 1000);      
        });
      });
    }

    function AfterCreate(data)
    {
    debugger;
      first.parents('.modal').modal('hide');
      prescript_id = data.Create;
      $('.prescript_id_receiver').val(data.Create);
      AddPerpecients
      (
        data.Create,
        [['hivrach', hivrach]],
        RedirectToPrint
      );
    }

    phoxy.ApiRequest
    (
      'prescript/Create', 
      [context.id, type.val(), name.val()],
      AfterCreate
    );  
  }

  first
    .nextAll("button[role='submit']")
    .click(function()
    {
      CreateOperation();
    });
};
%>

<%= this.chain(DeferCascade) %>
