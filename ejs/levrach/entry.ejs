<div id='cur_patient_choose'>
<%
var patient_id;
function Canceling()
{
  this.first().find('tr').find('th:last').after("<th></th>")
  this.first().find('tr').find('td:last').each(function()
  {
    var parent = $(this).parent();

    var id = parent.find("[data-mark='id']").html();
    var status = parent.find("[data-mark='status']").val();

    var addon = $('<td></td>');
    if (status == 'UNCONFIRMED')
    {
      var btn = 
        $('<a><span class="glyphicon glyphicon-remove-circle"></span></a>')
          .addClass('hipster')
          .click(function()
          {
            phoxy.ApiRequest('prescript/Delete', [id], function()
            {
              parent.remove();
            });
          })
          .tooltip({title: "Удалить"});

      addon.append(btn);

      btn = 
        $('<a><span class="glyphicon glyphicon-fire"></span></a>')
          .addClass('hipster')
          .click(function()
          {
            phoxy.ApiRequest('prescript/MakeCritical', [id], function()
            {
              
            });
          })
          .tooltip({title: "Неотложное/Критическое"});

      addon.append(btn);
    }
    
    $(this).after(addon);
  });
}

function OnPatientInfoRendered(ejs, data)
{
  console.log(arguments);

  $('#patient_content')
    .prepend
    (
      phoxy.DeferRender('levrach/create_oper_button.ejs', data),
      "<br>"
    )
    .append
    (
      phoxy.DeferRender('prescript/GetList?id=' + patient_id, undefined, Canceling)
    );
};
%>

<%= this.DeferRender('patient/Select', undefined, function()
{
  $(this.first().find('input')).change(function()
  {
    patient_id = $(this).val();
    phoxy.RenderInto
    (
      '#patient_content',
      'patient/Info?id=' + patient_id,
      undefined,
      OnPatientInfoRendered
    );
  });
}) %>
</div>

<div id='patient_content'>
</div>
<script src='js/approve.js' language='javascript'></script>
